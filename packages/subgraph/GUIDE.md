# Subgraph Template Usage Guide

## Introduction

This guide will walk you through the process of creating a subgraph for a smart contract. It will cover the following topics:

- [Subgraph Template Usage Guide](#subgraph-template-usage-guide)
  - [Introduction](#introduction)
  - [Install dependencies](#install-dependencies)
  - [Included scripts and `.env` file](#included-scripts-and-env-file)
  - [Creating a Subgraph](#creating-a-subgraph)
    - [`manifest/subgraph.placeholder.yaml`](#manifestsubgraphplaceholderyaml)
    - [`schema.graphql`](#schemagraphql)
  - [Handlers](#handlers)

## Install dependencies

Before you begin, make sure you installed the necessary dependencies. This template uses `yarn` so make sure you have it installed. You can install it by running the following command:

```bash
npm install -g yarn
```

After that you can install the dependencies by running:

```bash
yarn install
```

## Included scripts and `.env` file

The current repo contains a set of 3 scripts to help you get started with your subgraph. These scripts are located in the `scripts` folder and are the following:

- `build-manifest.sh`: Builds the `subgraph.yaml` file from the `subgraph.template.yaml` file.
- `build-subgraph.sh`: Builds the subgraph from the `subgraph.yaml` file generated by the `build-manifest.sh` script.
- `deploy-subgraph.sh`: Deploys the subgraph.

These 3 scripts can be called with the `yarn` command:

```bash
# Build the subgraph.yaml file
yarn build:manifest
# Build the subgraph
yarn build:subgraph
# Deploy the subgraph
yarn deploy
```

**REMEMBER**: You need to build the contracts before building the subgraph. You can do that by running `yarn build:contracts`

If you use `yarn build` it will build the contracts, the subgraph.yaml file and the subgraph in that order.

This scripts depend on the `.env` file located in the root of the repo. This file contains some variables that are relevant for this scripts. The variables are the following:

```bash
# SUBGRAPH

## The Graph credentials
GRAPH_KEY="zzzzzzzzzzzz"

## Subgraph
SUBGRAPH_NAME="osx"
SUBGRAPH_VERSION="v1.0.0"
SUBGRAPH_NETWORK_NAME="mainnet" #  ["mainnet", "goerli", "sepolia", "polygon", "polygonMumbai", "base", "baseGoerli", "arbitrum", "arbitrumGoerli"]
```

- `GRAPH_KEY`: This key will be used for deploying the subgraph.
- `SUBGRAPH_NAME`: The name of the subgraph.
- `SUBGRAPH_VERSION`: The version of the subgraph.
- `SUBGRAPH_NETWORK_NAME`: The network where the subgraph will be deployed. This will be used for generating the subgraph.yaml file.

Editing this variables you can change how the subgraph is built and deployed.

## Creating a Subgraph

### `manifest/subgraph.placeholder.yaml`

The first step to create a subgraph is to create or edit the `subgraph.placeholder.yaml` file. This file is located in the `manifest` folder. This file contains the template for the `subgraph.yaml` file. This file is used by the `build-manifest.sh` script to generate the `subgraph.yaml` file. You can find more information about the `subgraph.yaml` file [here](https://thegraph.com/docs/define-a-subgraph#the-subgraph-manifest).

You will see that the `subgraph.placeholder.yaml` file contains some placeholders that will be replaced by the `build-manifest.sh` script. These placeholders are the following:

- `{{dataSources.PluginSetupProcessors}}`: The object containing the processors for the plugin setup events.
- `{{startBlock}}`: The block number where the subgraph will start indexing.
- `{{address}}`: The address of the contract that will be indexed.
- `{{network}}`: The network where the contract is deployed.

This placeholder are substituted using moustache. You can find more information about it [here](https://mustache.github.io/).

The files containing the replacement values are stored in `manifest/data`. Here you can find a JSON file for each network. The name of the file is the name of the network. For example, the file for the mainnet network is `mainnet.json`. This file contains a property called `dataSources` which holds the information about the contract that will be indexed. In this case, we are only indexing one contract but you can index multiple contracts by adding more objects to the `dataSources` object.

### `schema.graphql`

The second step to create a subgraph is to define the schema. The schema is defined in the `schema.graphql` file located in the `subgraph` folder. This file contains the GraphQL schema that will be used for querying the subgraph. The schema is defined using the GraphQL Schema Definition Language (SDL). You can find more information about it [here](https://graphql.org/learn/schema/).

Here you can add your custom entities and how they are related to each other. You can find more information about the schema [here](https://thegraph.com/docs/define-a-subgraph#defining-the-schema).

## Handlers

the handling functions will be handling the events specified in the `subgraph.yaml` file. The functions are located in the `src` folder. For this specific case we have 2 handlers:

- `handleInstallationPrepared`: Handeles the `InstallationPrepared` event. This event is emitted when the installation is prepared. This event contains the `installationId` and the handler will create a new `PluginEntity` entity with the `installationId` as the id.
- `handleNumberStored`: Handles the `NumberStored` event. And stores the number in the `pluginEntity` entity in the `number` property.
